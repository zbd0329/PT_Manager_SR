<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT Tracker - 추천운동관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="/static/css/style.css" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .session-list {
            max-height: 600px;
            overflow-y: auto;
        }
        .select2-container {
            width: 100% !important;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">추천운동관리</h3>
                        <div>
                            <span class="me-3" id="userName">{{ user_name }}</span>
                            <button onclick="handleLogout()" class="btn btn-outline-danger">로그아웃</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <a href="/trainer/dashboard" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> 대시보드로 돌아가기
                            </a>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">PT 세션 선택</h5>
                                        <div class="mb-3">
                                            <label for="memberSelect" class="form-label">회원 선택</label>
                                            <select id="memberSelect" class="form-select">
                                                <option value="">회원을 선택하세요</option>
                                            </select>
                                        </div>
                                        <div class="session-list mt-4">
                                            <div id="sessionList" class="list-group">
                                                <!-- PT 세션 목록이 여기에 동적으로 추가됩니다 -->
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button id="createWorkoutBtn" class="btn btn-primary" disabled onclick="createWorkout()">
                                                Create Workout
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">AI 추천운동 목록</h5>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>No</th>
                                                        <th>최종수정일</th>
                                                        <th>운동정보</th>
                                                        <th>관리</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="workoutList">
                                                    <!-- 운동 프로그램 목록이 여기에 동적으로 추가됩니다 -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // 페이지 로드 시 인증 체크 및 사용자 정보 표시
        window.onload = async function() {
            try {
                const response = await fetch('/api/member/verify-auth', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Authentication failed');
                }

                const data = await response.json();
                console.log('Auth verification response:', data);

                // 사용자 타입 확인
                if (data.user_data.user_type !== 'TRAINER') {
                    throw new Error('Unauthorized access');
                }

                // 사용자 이름 표시
                const userName = localStorage.getItem('user_name');
                if (userName) {
                    document.getElementById('userName').textContent = `${userName} 트레이너님`;
                }

                // 회원 목록 로드
                await loadMembers();

            } catch (error) {
                console.error('Authentication error:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '인증 오류',
                    text: '로그인이 필요합니다.',
                    confirmButtonText: '확인'
                });
                window.location.href = '/';
            }
        };

        // Select2 초기화
        $(document).ready(function() {
            $('#memberSelect').select2({
                placeholder: '회원을 선택하세요',
                allowClear: true
            });

            // 회원 선택 이벤트
            $('#memberSelect').on('change', async function() {
                const memberId = $(this).val();
                if (memberId) {
                    await loadPTSessions(memberId);
                    await loadRecommendedWorkouts(memberId);
                } else {
                    $('#sessionList').empty();
                    $('#workoutList').empty();
                    $('#createWorkoutBtn').prop('disabled', true);
                }
            });
        });

        // 회원 목록 로드
        async function loadMembers() {
            try {
                console.log('Loading members...');
                const response = await fetch('/api/v1/members', {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error('Failed to load members');
                }

                const members = await response.json();
                console.log('Loaded members:', members);
                
                const select = $('#memberSelect');
                select.empty().append('<option value="">회원을 선택하세요</option>');
                
                if (Array.isArray(members)) {
                    members.forEach(member => {
                        console.log('Adding member:', member);
                        select.append(`<option value="${member.id}">${member.name}</option>`);
                    });
                } else {
                    console.error('Members is not an array:', members);
                }

                // Select2 재초기화
                select.trigger('change');
            } catch (error) {
                console.error('Error loading members:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '회원 목록 로드 실패',
                    text: '회원 목록을 불러오는데 실패했습니다.',
                    confirmButtonText: '확인'
                });
            }
        }

        // PT 세션 목록 로드
        async function loadPTSessions(memberId) {
            try {
                const response = await fetch(`/api/v1/recommended-workouts/sessions/${memberId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load PT sessions');
                }

                const sessions = await response.json();
                const sessionList = document.getElementById('sessionList');
                sessionList.innerHTML = '';

                sessions.forEach((session, index) => {
                    sessionList.innerHTML += `
                        <div class="list-group-item">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sessionRadio" 
                                       id="session${index}" value="${session.id}">
                                <label class="form-check-label" for="session${index}">
                                    ${session.session_date} (${session.start_time} ~ ${session.end_time})
                                    <br>
                                    <small class="text-muted">세션 ${session.session_number}회차</small>
                                </label>
                            </div>
                        </div>
                    `;
                });

                // 세션 선택 이벤트 리스너 추가
                $('input[name="sessionRadio"]').on('change', function() {
                    $('#createWorkoutBtn').prop('disabled', false);
                });

            } catch (error) {
                console.error('Error loading PT sessions:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'PT 세션 로드 실패',
                    text: 'PT 세션 목록을 불러오는데 실패했습니다.',
                    confirmButtonText: '확인'
                });
            }
        }

        // 추천운동 목록 로드
        async function loadRecommendedWorkouts(memberId = null) {
            try {
                let url = '/api/v1/recommended-workouts';
                if (memberId) {
                    url += `?member_id=${memberId}`;
                }

                const response = await fetch(url, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load workouts');
                }

                const workouts = await response.json();
                const workoutList = document.getElementById('workoutList');
                workoutList.innerHTML = '';

                workouts.forEach((workout, index) => {
                    const date = new Date(workout.updated_at).toLocaleDateString('ko-KR');
                    workoutList.innerHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${date}</td>
                            <td>
                                <div>${workout.workout_name}</div>
                                <small class="text-muted">총 ${workout.total_duration}분</small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewWorkout('${workout.id}')">
                                    <i class="bi bi-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="editWorkout('${workout.id}')">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteWorkout('${workout.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error('Error loading workouts:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '운동 프로그램 로드 실패',
                    text: '운동 프로그램 목록을 불러오는데 실패했습니다.',
                    confirmButtonText: '확인'
                });
            }
        }

        // 추천운동 상세보기
        async function viewWorkout(id) {
            try {
                const response = await fetch(`/api/v1/recommended-workouts/${id}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load workout details');
                }

                const workout = await response.json();
                const exercisesHtml = workout.exercises.map((exercise, index) => `
                    <div class="mb-4">
                        <h6>운동 ${index + 1}</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <p><strong>운동명:</strong> ${exercise.exercise_name}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>세트:</strong> ${exercise.sets}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>횟수:</strong> ${exercise.repetitions}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>시간:</strong> ${exercise.duration}초</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>휴식:</strong> ${exercise.rest_time}초</p>
                            </div>
                            <div class="col-12">
                                <p><strong>설명:</strong> ${exercise.description}</p>
                            </div>
                        </div>
                    </div>
                `).join('');

                Swal.fire({
                    title: workout.workout_name,
                    html: `
                        <div class="text-start">
                            <div class="mb-4">
                                <p><strong>작성일:</strong> ${new Date(workout.created_at).toLocaleDateString('ko-KR')}</p>
                                <p><strong>총 운동 시간:</strong> ${workout.total_duration}분</p>
                            </div>
                            <div class="exercises">
                                ${exercisesHtml}
                            </div>
                        </div>
                    `,
                    width: '800px',
                    confirmButtonText: '확인',
                    showCloseButton: true
                });

            } catch (error) {
                console.error('Error viewing workout:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '운동 프로그램 조회 실패',
                    text: '운동 프로그램 정보를 불러오는데 실패했습니다.',
                    confirmButtonText: '확인'
                });
            }
        }

        // 추천운동 수정
        async function editWorkout(id) {
            try {
                const response = await fetch(`/api/v1/recommended-workouts/${id}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load workout details');
                }

                const workout = await response.json();
                const exercisesHtml = workout.exercises.map((exercise, index) => `
                    <div class="mb-4 border p-3 rounded">
                        <h6>운동 ${index + 1}</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">운동명</label>
                                <input type="text" class="form-control" value="${exercise.exercise_name}" name="exercises[${index}].exercise_name">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">세트</label>
                                <input type="number" class="form-control" value="${exercise.sets}" name="exercises[${index}].sets">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">횟수</label>
                                <input type="number" class="form-control" value="${exercise.repetitions}" name="exercises[${index}].repetitions">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">시간(초)</label>
                                <input type="number" class="form-control" value="${exercise.duration}" name="exercises[${index}].duration">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">휴식(초)</label>
                                <input type="number" class="form-control" value="${exercise.rest_time}" name="exercises[${index}].rest_time">
                            </div>
                            <div class="col-12">
                                <label class="form-label">설명</label>
                                <textarea class="form-control" name="exercises[${index}].description" rows="2">${exercise.description}</textarea>
                            </div>
                        </div>
                    </div>
                `).join('');

                Swal.fire({
                    title: '추천운동 수정',
                    html: `
                        <form id="editWorkoutForm" class="text-start">
                            <div class="mb-3">
                                <label class="form-label">프로그램명</label>
                                <input type="text" class="form-control" value="${workout.workout_name}" name="workout_name">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">총 운동 시간(분)</label>
                                <input type="number" class="form-control" value="${workout.total_duration}" name="total_duration">
                            </div>
                            <div class="exercises">
                                ${exercisesHtml}
                            </div>
                        </form>
                    `,
                    width: '800px',
                    showCancelButton: true,
                    confirmButtonText: '저장',
                    cancelButtonText: '취소',
                    showCloseButton: true,
                    preConfirm: () => {
                        // 여기에서 폼 데이터를 수집하고 API로 전송하는 로직이 들어갈 예정
                        return new Promise((resolve) => {
                            // 임시로 성공 메시지만 표시
                            resolve();
                        });
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            icon: 'success',
                            title: '수정 완료',
                            text: '추천운동이 성공적으로 수정되었습니다.',
                            confirmButtonText: '확인'
                        });
                    }
                });

            } catch (error) {
                console.error('Error editing workout:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '운동 프로그램 수정 실패',
                    text: '운동 프로그램 정보를 불러오는데 실패했습니다.',
                    confirmButtonText: '확인'
                });
            }
        }

        // 추천운동 삭제
        async function deleteWorkout(id) {
            try {
                const result = await Swal.fire({
                    title: '운동 프로그램 삭제',
                    text: '정말로 이 운동 프로그램을 삭제하시겠습니까?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: '삭제',
                    cancelButtonText: '취소',
                    confirmButtonColor: '#dc3545'
                });

                if (result.isConfirmed) {
                    const response = await fetch(`/api/v1/recommended-workouts/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error('Failed to delete workout');
                    }

                    await Swal.fire({
                        icon: 'success',
                        title: '삭제 완료',
                        text: '운동 프로그램이 성공적으로 삭제되었습니다.',
                        confirmButtonText: '확인'
                    });

                    // 목록 새로고침
                    await loadRecommendedWorkouts();
                }
            } catch (error) {
                console.error('Error deleting workout:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '삭제 실패',
                    text: '운동 프로그램 삭제에 실패했습니다.',
                    confirmButtonText: '확인'
                });
            }
        }

        // 로그아웃 처리
        async function handleLogout() {
            try {
                localStorage.removeItem('user_name');
                localStorage.removeItem('user_type');
                document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '로그아웃 실패',
                    text: '로그아웃 처리 중 오류가 발생했습니다.',
                    confirmButtonText: '확인'
                });
            }
        }

        // 추천운동 생성
        async function createWorkout() {
            try {
                const memberId = $('#memberSelect').val();
                const sessionId = $('input[name="sessionRadio"]:checked').val();

                if (!memberId || !sessionId) {
                    throw new Error('회원과 PT 세션을 선택해주세요.');
                }

                // 회원 정보 가져오기
                const memberResponse = await fetch(`/api/v1/members/${memberId}`, {
                    credentials: 'include'
                });

                if (!memberResponse.ok) {
                    throw new Error('회원 정보를 가져오는데 실패했습니다.');
                }

                const memberData = await memberResponse.json();

                // 선택한 PT 세션의 운동 기록 가져오기
                const exerciseResponse = await fetch(`/api/v1/exercise-records/session/${sessionId}`, {
                    credentials: 'include'
                });

                if (!exerciseResponse.ok) {
                    throw new Error('운동 기록을 가져오는데 실패했습니다.');
                }

                const exerciseData = await exerciseResponse.json();

                // OpenAI API 요청 데이터 구성
                const requestData = {
                    member_name: memberData.name,
                    gender: memberData.gender,
                    fitness_goal: memberData.fitness_goal,
                    pt_duration: memberData.session_duration,
                    preferred_exercises: memberData.preferred_exercises,
                    remaining_sessions: memberData.remaining_pt_count,
                    injuries: memberData.injuries,
                    exercise_level: memberData.experience_level,
                    session_id: sessionId,
                    exercise_history: exerciseData.exercises || []  // 선택한 세션의 운동 기록
                };

                // 로딩 표시
                Swal.fire({
                    title: '추천운동 생성 중...',
                    html: 'AI가 최적의 운동을 추천하고 있습니다.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // OpenAI API 호출
                const aiResponse = await fetch('/api/v1/recommended-workouts/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestData)
                });

                if (!aiResponse.ok) {
                    throw new Error('AI 추천운동 생성에 실패했습니다.');
                }

                const workoutPlan = await aiResponse.json();

                // 로딩 닫기
                Swal.close();

                // 추천된 운동 프로그램 확인 모달
                const exercisesHtml = workoutPlan.exercises.map((exercise, index) => `
                    <div class="mb-4 border p-3 rounded">
                        <h6>운동 ${index + 1}</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <p><strong>운동명:</strong> ${exercise.exercise_name}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>세트:</strong> ${exercise.sets}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>횟수:</strong> ${exercise.repetitions}</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>시간:</strong> ${exercise.duration}초</p>
                            </div>
                            <div class="col-md-3">
                                <p><strong>휴식:</strong> ${exercise.rest_time}초</p>
                            </div>
                            <div class="col-12">
                                <p><strong>설명:</strong> ${exercise.description}</p>
                            </div>
                        </div>
                    </div>
                `).join('');

                Swal.fire({
                    title: 'AI 추천 운동 프로그램',
                    html: `
                        <div class="text-start">
                            <div class="mb-4">
                                <p><strong>회원명:</strong> ${memberData.name}</p>
                                <p><strong>운동 목표:</strong> ${memberData.fitness_goal}</p>
                                <p><strong>총 운동 시간:</strong> ${workoutPlan.total_duration}분</p>
                            </div>
                            <div class="exercises">
                                ${exercisesHtml}
                            </div>
                        </div>
                    `,
                    width: '800px',
                    showCancelButton: true,
                    confirmButtonText: 'Send Workout',
                    cancelButtonText: '취소',
                    showCloseButton: true
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            // 운동 프로그램 저장 API 호출
                            const saveResponse = await fetch('/api/v1/recommended-workouts', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                credentials: 'include',
                                body: JSON.stringify({
                                    member_id: memberId,
                                    session_id: sessionId,
                                    workout_plan: workoutPlan
                                })
                            });

                            if (!saveResponse.ok) {
                                throw new Error('운동 프로그램 저장에 실패했습니다.');
                            }

                            await Swal.fire({
                                icon: 'success',
                                title: '저장 완료',
                                text: '추천운동이 성공적으로 저장되었습니다.',
                                confirmButtonText: '확인'
                            });

                            // 페이지 새로고침
                            location.reload();

                        } catch (error) {
                            console.error('Save error:', error);
                            await Swal.fire({
                                icon: 'error',
                                title: '저장 실패',
                                text: error.message,
                                confirmButtonText: '확인'
                            });
                        }
                    }
                });

            } catch (error) {
                console.error('Create workout error:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '추천운동 생성 실패',
                    text: error.message,
                    confirmButtonText: '확인'
                });
            }
        }
    </script>
</body>
</html> 