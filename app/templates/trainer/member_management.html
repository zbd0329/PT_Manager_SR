<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT Tracker - 회원 관리</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/static/css/style.css" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">회원 관리</h3>
                        <div>
                            <button id="showRegistrationForm" class="btn btn-primary me-2">회원 등록</button>
                            <a href="/trainer/dashboard" class="btn btn-outline-secondary">돌아가기</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 회원 목록 영역 -->
                        <div id="memberList" class="mb-4">
                            <h4 class="mb-4">회원 목록</h4>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>이름</th>
                                            <th>로그인 ID</th>
                                            <th>성별</th>
                                            <th>연락처</th>
                                            <th>PT 횟수</th>
                                            <th>특이사항</th>
                                            <th>작업</th>
                                        </tr>
                                    </thead>
                                    <tbody id="memberTableBody">
                                        <!-- 회원 데이터가 여기에 동적으로 추가됩니다 -->
                                    </tbody>
                                </table>
                            </div>
                            <!-- 페이지네이션 -->
                            <nav aria-label="Page navigation" class="mt-4">
                                <ul class="pagination justify-content-center" id="pagination">
                                    <!-- 페이지 번호가 여기에 동적으로 추가됩니다 -->
                                </ul>
                            </nav>
                        </div>

                        <!-- 회원 등록 폼 (초기에는 숨김) -->
                        <div id="registrationFormContainer" style="display: none;">
                            <h4 class="mb-4">새 회원 등록</h4>
                            <form id="memberRegistrationForm">
                                <div class="mb-3">
                                    <label for="loginId" class="form-label">로그인 ID</label>
                                    <input type="text" class="form-control" id="loginId" required minlength="4">
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">비밀번호</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="name" class="form-label">이름</label>
                                    <input type="text" class="form-control" id="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="gender" class="form-label">성별</label>
                                    <select class="form-select" id="gender" required>
                                        <option value="M">남성</option>
                                        <option value="F">여성</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="contact" class="form-label">연락처</label>
                                    <input type="text" class="form-control" id="contact" required 
                                           placeholder="예: 010-1234-5678">
                                </div>
                                <div class="mb-3">
                                    <label for="ptCount" class="form-label">PT 횟수</label>
                                    <input type="number" class="form-control" id="ptCount" min="0" value="0">
                                </div>
                                <div class="mb-3">
                                    <label for="notes" class="form-label">특이사항</label>
                                    <textarea class="form-control" id="notes" rows="3"></textarea>
                                </div>
                                <div class="d-flex justify-content-end gap-2">
                                    <button type="button" class="btn btn-secondary" id="cancelRegistration">취소</button>
                                    <button type="submit" class="btn btn-primary">등록</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let currentPage = 1;
        const itemsPerPage = 10;
        let totalMembers = 0;

        // 공통 에러 처리 함수
        async function handleAuthError(error) {
            console.error('Authentication error:', error);
            await Swal.fire({
                icon: 'error',
                title: '인증 오류',
                text: error.message || '인증에 실패했습니다. 다시 로그인해주세요.',
                confirmButtonText: '확인'
            });
            window.location.href = '/';
        }

        // API 요청 공통 처리 함수
        async function fetchWithAuth(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    credentials: 'include'
                });

                if (!response.ok) {
                    const data = await response.json();
                    if (response.status === 401 || response.status === 403 || data.detail?.includes('토큰')) {
                        throw new Error(data.detail || '인증에 실패했습니다.');
                    }
                    throw new Error(data.detail || '요청 처리 중 오류가 발생했습니다.');
                }

                return response;
            } catch (error) {
                if (error.message.includes('토큰') || error.message.includes('인증')) {
                    await handleAuthError(error);
                }
                throw error;
            }
        }

        // 페이지 로드 시 회원 목록 조회
        window.onload = async function() {
            try {
                // 토큰 유효성 검증
                const response = await fetchWithAuth('/api/member/verify-auth');
                const data = await response.json();

                if (data.user_data.user_type !== 'TRAINER') {
                    throw new Error('트레이너 권한이 필요합니다.');
                }

                // 회원 목록 로드
                loadMembers(0);
            } catch (error) {
                await handleAuthError(error);
            }
        };

        // 회원 목록 조회 함수
        async function loadMembers(skip) {
            try {
                const response = await fetchWithAuth(`/api/v1/members?skip=${skip}&limit=${itemsPerPage}`);
                const members = await response.json();
                const totalCount = parseInt(response.headers.get('x-total-count') || '0');
                totalMembers = totalCount;
                displayMembers(members);
                updatePagination(Math.ceil(totalCount / itemsPerPage));
            } catch (error) {
                console.error('Error:', error);
                if (!error.message.includes('토큰') && !error.message.includes('인증')) {
                    await Swal.fire({
                        icon: 'error',
                        title: '조회 실패',
                        text: error.message,
                        confirmButtonText: '확인'
                    });
                }
            }
        }

        // 회원 목록 표시 함수
        function displayMembers(members) {
            const tbody = document.getElementById('memberTableBody');
            tbody.innerHTML = '';

            members.forEach(member => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.login_id}</td>
                    <td>${member.gender === 'M' ? '남성' : '여성'}</td>
                    <td>${member.contact}</td>
                    <td>${member.pt_count}</td>
                    <td>${member.notes || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-member" data-member-id="${member.id}">
                            수정
                        </button>
                    </td>
                `;
                tbody.appendChild(row);

                // 수정 버튼에 이벤트 리스너 추가
                row.querySelector('.edit-member').addEventListener('click', () => loadMemberForEdit(member.id));
            });
        }

        // 회원 정보 수정을 위한 데이터 로드
        async function loadMemberForEdit(memberId) {
            try {
                const response = await fetchWithAuth(`/api/v1/members/${memberId}`);
                const member = await response.json();
                showEditForm(member);
            } catch (error) {
                console.error('Error:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '조회 실패',
                    text: error.message,
                    confirmButtonText: '확인'
                });
            }
        }

        // 수정 폼 표시
        function showEditForm(member) {
            // 기존 폼의 ID를 변경하고 수정용 필드 추가
            const registrationForm = document.getElementById('memberRegistrationForm');
            
            // 기존 이벤트 리스너 제거
            const clonedForm = registrationForm.cloneNode(true);
            registrationForm.parentNode.replaceChild(clonedForm, registrationForm);
            
            const editForm = clonedForm;
            editForm.id = 'memberEditForm';
            
            // 폼 데이터 설정
            editForm.querySelector('#name').value = member.name;
            editForm.querySelector('#gender').value = member.gender;
            editForm.querySelector('#contact').value = member.contact;
            editForm.querySelector('#ptCount').value = member.pt_count;
            editForm.querySelector('#notes').value = member.notes || '';
            
            // 로그인 ID 필드를 읽기 전용으로 변경
            const loginIdField = editForm.querySelector('#loginId');
            loginIdField.value = member.login_id;
            loginIdField.readOnly = true;
            
            // 비밀번호 필드 레이블 변경
            const passwordLabel = editForm.querySelector('label[for="password"]');
            passwordLabel.textContent = '비밀번호 (변경 시에만 입력)';
            const passwordField = editForm.querySelector('#password');
            passwordField.value = '';
            passwordField.required = false;
            
            // 폼 제목 변경
            const formTitle = document.querySelector('#registrationFormContainer h4');
            formTitle.textContent = '회원 정보 수정';
            
            // 버튼 텍스트 변경
            const submitButton = editForm.querySelector('button[type="submit"]');
            submitButton.textContent = '수정';
            
            // 폼 표시
            document.getElementById('registrationFormContainer').style.display = 'block';
            document.getElementById('memberList').style.display = 'none';
            document.getElementById('showRegistrationForm').style.display = 'none';
            
            // 수정 폼 제출 이벤트 리스너 추가
            editForm.onsubmit = (e) => handleEditSubmit(e, member.id);
        }

        // 수정 폼 제출 처리
        async function handleEditSubmit(e, memberId) {
            e.preventDefault();

            const memberData = {
                name: document.getElementById('name').value,
                gender: document.getElementById('gender').value,
                contact: document.getElementById('contact').value,
                pt_count: parseInt(document.getElementById('ptCount').value),
                notes: document.getElementById('notes').value || null
            };

            // 비밀번호가 입력된 경우에만 포함
            const password = document.getElementById('password').value;
            if (password) {
                memberData.password = password;
            }

            try {
                const response = await fetchWithAuth(`/api/v1/members/${memberId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(memberData)
                });

                // 응답 데이터를 먼저 확인
                console.log('서버 응답 상태:', response.status);
                const responseData = await response.json();
                console.log('서버 응답 데이터:', responseData);

                if (response.ok) {
                    await Swal.fire({
                        icon: 'success',
                        title: '회원 정보 수정 성공!',
                        text: '회원 정보가 성공적으로 수정되었습니다.',
                        confirmButtonText: '확인'
                    });
                    
                    // 폼 초기화 및 원래 상태로 복구
                    resetForm();
                    // 회원 목록 새로고침
                    loadMembers((currentPage - 1) * itemsPerPage);
                } else {
                    if (response.status === 401) {
                        await Swal.fire({
                            icon: 'error',
                            title: '세션 만료',
                            text: '로그인이 만료되었습니다. 다시 로그인해주세요.',
                            confirmButtonText: '확인'
                        });
                        window.location.href = '/';
                        return;
                    }
                    throw new Error(responseData.detail || '회원 정보 수정 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('Error:', error);
                await Swal.fire({
                    icon: 'error',
                    title: '수정 실패',
                    text: error.message,
                    confirmButtonText: '확인'
                });
                // 오류 발생 시에도 폼을 유지하고 사용자가 다시 시도할 수 있도록 함
                return; // 오류 발생 시 여기서 함수 종료
            }
        }

        // 폼 초기화 및 원래 상태로 복구
        function resetForm() {
            const form = document.getElementById('memberEditForm') || document.getElementById('memberRegistrationForm');
            
            // 이벤트 리스너 제거를 위한 폼 복제
            const clonedForm = form.cloneNode(true);
            form.parentNode.replaceChild(clonedForm, form);
            
            // 새로운 등록 폼으로 설정
            clonedForm.id = 'memberRegistrationForm';
            clonedForm.reset();
            
            // 로그인 ID 필드 초기화
            const loginIdField = clonedForm.querySelector('#loginId');
            loginIdField.readOnly = false;
            
            // 비밀번호 필드 초기화
            const passwordLabel = clonedForm.querySelector('label[for="password"]');
            passwordLabel.textContent = '비밀번호';
            const passwordField = clonedForm.querySelector('#password');
            passwordField.required = true;
            
            // 폼 제목 복구
            const formTitle = document.querySelector('#registrationFormContainer h4');
            formTitle.textContent = '새 회원 등록';
            
            // 버튼 텍스트 복구
            const submitButton = clonedForm.querySelector('button[type="submit"]');
            submitButton.textContent = '등록';
            
            // 폼 숨기기 및 목록 표시
            document.getElementById('registrationFormContainer').style.display = 'none';
            document.getElementById('memberList').style.display = 'block';
            document.getElementById('showRegistrationForm').style.display = 'inline-block';
            
            // 새로운 등록 폼 이벤트 리스너 설정
            setupRegistrationFormListener(clonedForm);
        }

        // 회원 등록 폼 이벤트 리스너 설정 함수
        function setupRegistrationFormListener(form) {
            if (!form) {
                form = document.getElementById('memberRegistrationForm');
            }
            
            if (form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();

                    const memberData = {
                        login_id: form.querySelector('#loginId').value,
                        password: form.querySelector('#password').value,
                        name: form.querySelector('#name').value,
                        gender: form.querySelector('#gender').value,
                        contact: form.querySelector('#contact').value,
                        pt_count: parseInt(form.querySelector('#ptCount').value),
                        notes: form.querySelector('#notes').value || null
                    };

                    try {
                        const response = await fetchWithAuth('/api/v1/members', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(memberData)
                        });

                        // 응답 데이터를 먼저 확인
                        console.log('서버 응답 상태:', response.status);
                        const responseData = await response.json();
                        console.log('서버 응답 데이터:', responseData);

                        if (response.ok) {
                            await Swal.fire({
                                icon: 'success',
                                title: '회원 등록 성공!',
                                text: '회원이 성공적으로 등록되었습니다.',
                                confirmButtonText: '확인'
                            });
                            resetForm();
                            loadMembers((currentPage - 1) * itemsPerPage);
                        } else {
                            const error = await response.json();
                            await Swal.fire({
                                icon: 'error',
                                title: '회원 등록 실패',
                                text: error.detail || '회원 등록 중 오류가 발생했습니다.',
                                confirmButtonText: '확인'
                            });
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        await Swal.fire({
                            icon: 'error',
                            title: '서버 오류',
                            text: '서버와의 통신 중 오류가 발생했습니다.',
                            confirmButtonText: '확인'
                        });
                    }
                };
            }
        }

        // 초기 등록 폼 이벤트 리스너 설정
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('memberRegistrationForm');
            if (form) {
                setupRegistrationFormListener(form);
            }
        });

        // 취소 버튼 클릭 시 처리 수정
        document.getElementById('cancelRegistration').addEventListener('click', () => {
            resetForm();
        });

        // 페이지네이션 업데이트 함수
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // 이전 페이지 버튼
            const prevButton = document.createElement('li');
            prevButton.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevButton.innerHTML = `
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            `;
            prevButton.onclick = (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    loadMembers((currentPage - 1) * itemsPerPage);
                }
            };
            pagination.appendChild(prevButton);

            // 페이지 번호 버튼
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // 시작 페이지 조정
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // 첫 페이지 버튼
            if (startPage > 1) {
                const firstPageButton = document.createElement('li');
                firstPageButton.className = 'page-item';
                firstPageButton.innerHTML = '<a class="page-link" href="#">1</a>';
                firstPageButton.onclick = (e) => {
                    e.preventDefault();
                    currentPage = 1;
                    loadMembers(0);
                };
                pagination.appendChild(firstPageButton);

                if (startPage > 2) {
                    const ellipsis = document.createElement('li');
                    ellipsis.className = 'page-item disabled';
                    ellipsis.innerHTML = '<a class="page-link">...</a>';
                    pagination.appendChild(ellipsis);
                }
            }

            // 페이지 번호 버튼
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('li');
                pageButton.className = `page-item ${currentPage === i ? 'active' : ''}`;
                pageButton.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                pageButton.onclick = (e) => {
                    e.preventDefault();
                    currentPage = i;
                    loadMembers((i - 1) * itemsPerPage);
                };
                pagination.appendChild(pageButton);
            }

            // 마지막 페이지 버튼
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('li');
                    ellipsis.className = 'page-item disabled';
                    ellipsis.innerHTML = '<a class="page-link">...</a>';
                    pagination.appendChild(ellipsis);
                }

                const lastPageButton = document.createElement('li');
                lastPageButton.className = 'page-item';
                lastPageButton.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
                lastPageButton.onclick = (e) => {
                    e.preventDefault();
                    currentPage = totalPages;
                    loadMembers((totalPages - 1) * itemsPerPage);
                };
                pagination.appendChild(lastPageButton);
            }

            // 다음 페이지 버튼
            const nextButton = document.createElement('li');
            nextButton.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextButton.innerHTML = `
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            `;
            nextButton.onclick = (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    loadMembers((currentPage - 1) * itemsPerPage);
                }
            };
            pagination.appendChild(nextButton);
        }

        // 회원 등록 폼 표시/숨김 토글
        document.getElementById('showRegistrationForm').addEventListener('click', () => {
            document.getElementById('registrationFormContainer').style.display = 'block';
            document.getElementById('memberList').style.display = 'none';
            document.getElementById('showRegistrationForm').style.display = 'none';
        });
    </script>
</body>
</html>