# 2024-03-03 개발 작업 정리

## 1. API 개발 및 수정 사항

### 1.1 회원 관리 API
- `GET /api/v1/members` : 회원 목록 조회 API 구현
  - 페이지네이션 기능 추가 (skip, limit 파라미터)
  - 전체 회원 수를 헤더(`X-Total-Count`)에 포함
- `POST /api/v1/members` : 회원 등록 API 구현
  - 트레이너별 회원 등록 기능
  - 비밀번호 암호화 처리
- `PUT /api/v1/members/{member_id}` : 회원 정보 수정 API 구현
  - 선택적 필드 업데이트 지원
  - 비밀번호 변경 시에만 암호화 처리

### 1.2 인증 관련 API
- `GET /api/member/verify-auth` : 토큰 유효성 검증 API 구현
  - 쿠키 기반 인증 토큰 검증
  - 사용자 타입별 권한 확인

## 2. 버그 수정 사항

### 2.1 로그인 관련 버그
- 로그인 후 리다이렉션 문제 해결
  - 쿠키 설정 후 즉시 리다이렉트되는 문제 수정
  - 500ms 딜레이 추가로 쿠키 설정 완료 보장

### 2.2 회원 관리 기능 버그
- 회원 정보 수정 시 Content-Type 헤더 누락 문제 해결
- 회원 등록 시 응답 데이터 로깅 추가로 디버깅 용이성 개선

## 3. 기술적 개선 사항

### 3.1 인증 시스템 개선
- localStorage에서 HTTP-only 쿠키 기반으로 변경
  ```javascript
  response.set_cookie(
      key="access_token",
      value=f"Bearer {access_token}",
      httponly=True,
      secure=False,  // 개발환경 설정
      samesite="lax",
      max_age=1800  // 30분
  )
  ```
- XSS 공격 방지를 위한 보안 강화

### 3.2 토큰 관리 개선
- JWT 토큰 페이로드 구조 개선
  ```python
  token_data = {
      "sub": str(user.id),
      "user_type": "TRAINER/MEMBER",
      "login_id": clean_login_id
  }
  ```
- 토큰 검증 로직 강화 및 디버그 로깅 추가

## 4. 주요 이슈 해결

### 4.1 인증 지속성 문제
- 문제: 페이지 새로고침 시 로그인 상태 초기화
- 원인: localStorage 기반 인증의 한계
- 해결: HTTP-only 쿠키 기반 인증으로 전환

### 4.2 사용자 타입 검증 문제
- 문제: 대소문자 구분으로 인한 권한 검증 실패
- 원인: 문자열 비교 시 대소문자 불일치
- 해결: 
  ```python
  user_type = raw_user_type.strip().upper()
  if user_type != "TRAINER":
      raise HTTPException(...)
  ```

### 4.3 회원 관리 동시성 문제
- 문제: 여러 트레이너가 동시에 회원 정보 수정 시 충돌
- 해결: 트레이너 ID 기반 필터링 추가
  ```python
  db.query(Member)\
    .filter(Member.id == member_id)\
    .filter(Member.trainer_id == current_user.get("sub"))\
    .first()
  ```

## 5. 다음 작업 계획
- 회원아이디 활성/비활성 버튼 개발

## 6. 오늘 관련내용 
- git 브랜치를 날려서 작업한것을 날렸다면? 돈워리
- 커밋 관련 rules 정하기 (커밋메세지 작성 규칙,push까지 해줘, 기능개발 혹은 버그 수정후 커밋하라고 추천하기 등)
- compose는 날짜별, 혹은 기능 개발별로 새로 만들어서 사용하자
- 오늘 개발한 내용 문서로 작성하기 (문서작성 rules 정하기 -버그해결관련된 것은 자세하기 기록하기, 어떻게 해결했는지, 어떤 코드가 문제였는지, 수정후 코드는 어떻게 바뀌었는지 자세히 적게 할 수 있음) -> 추후 문서의 퀄리티 변천사도 적으면 좋을듯 