## **📅 2024년 3월 20일 개발 작업 정리**

### **✅ 1. API 개발 및 수정 사항**
- AI 추천 운동 프로그램 관련 API 개발 및 수정
  - 엔드포인트: `/api/v1/recommended-workouts/generate`
  - 기능: OpenAI API를 활용한 맞춤형 운동 프로그램 생성
  - 주요 변경 사항: 
    - 회원의 운동 수준 반영
    - 준비/마무리 운동 추가
    - 운동 시간 자동 계산 기능
    - LangChain 라이브러리 도입으로 API 호출 방식 개선

예제 요청:
```json
{
    "member_id": "550e8400-e29b-41d4-a716-446655440000",
    "session_id": "123e4567-e89b-12d3-a456-426614174000",
    "member_name": "홍길동",
    "gender": "MALE",
    "fitness_goal": "체중 감량",
    "pt_duration": 60,
    "preferred_exercises": ["요가", "필라테스"],
    "remaining_sessions": 10,
    "has_injury": true,
    "injury_description": "어깨 통증이 있음",
    "exercise_level": "BEGINNER"
}
```

예제 응답:
```json
{
    "workout_name": "초급자 맞춤 전신 운동 프로그램",
    "total_duration": 60,
    "exercises": [
        {
            "exercise_name": "가벼운 스트레칭",
            "sets": 1,
            "repetitions": 10,
            "duration": 300,
            "rest_time": 30,
            "description": "전신 스트레칭으로 준비운동",
            "sequence": 1
        },
        {
            "exercise_name": "숄더 프레스",
            "sets": 3,
            "repetitions": 12,
            "duration": 45,
            "rest_time": 60,
            "description": "어깨 통증을 고려한 가벼운 무게로 실시",
            "sequence": 2
        }
    ]
}
```

### **✅ 2. 버그 수정 사항**
- OpenAI API 키 노출 문제 해결
  - 문제 원인: `.env` 파일이 Git에 직접 커밋되어 API 키가 노출됨
  - 해결 방법:
    1. Git 히스토리에서 `.env` 파일 완전 제거
    2. `.gitignore`에 `.env` 추가
    3. `.env.example` 파일 생성하여 환경 변수 형식 공유

### **✅ 3. 기술적 개선 사항**
1. OpenAI API 호출 방식 개선
   ```python
   # 기존 코드 (직접 OpenAI API 사용)
   import openai
   openai.api_key = settings.OPENAI_API_KEY
   
   response = openai.ChatCompletion.create(
       model="gpt-3.5-turbo",
       messages=[{"role": "user", "content": prompt}]
   )

   # 개선된 코드 (LangChain 사용)
   from langchain_openai import ChatOpenAI
   from langchain_community.callbacks import get_openai_callback
   
   llm = ChatOpenAI(
       temperature=settings.OPENAI_TEMPERATURE,
       model_name=settings.OPENAI_MODEL,
       openai_api_key=settings.OPENAI_API_KEY,
       streaming=False
   )

   with get_openai_callback() as cb:
       response = llm.invoke(prompt)
       print(f"토큰 사용량: {cb.total_tokens}")
       print(f"비용: ${cb.total_cost:.6f}")
   ```

2. 순환 참조 문제 해결
   ```python
   # 기존 코드 (순환 참조 발생)
   # member_model.py
   from app.models.pt_session import PTSession
   
   class Member(Base):
       pt_sessions = relationship("PTSession", back_populates="member")

   # pt_session.py
   from app.models.member_model import Member
   
   class PTSession(Base):
       member = relationship("Member", back_populates="pt_sessions")

   # 개선된 코드 (문자열로 참조)
   # member_model.py
   class Member(Base):
       pt_sessions = relationship("PTSession", back_populates="member")

   # pt_session.py
   class PTSession(Base):
       member = relationship("Member", back_populates="pt_sessions")
   ```

### **🔥 4. 주요 이슈 해결 (가장 많은 시간 투자)**
1. **순환 참조 문제 (해결에 가장 많은 시간 소요)**
   - 문제: 모델 간의 상호 참조로 인한 순환 참조 발생
   - 원인 분석: 
     - Member와 PTSession 모델이 서로를 직접 import하면서 순환 참조 발생
     - 이로 인해 애플리케이션 시작 시 ImportError 발생
   - 문제가 된 코드:
     ```python
     # app/models/member_model.py
     from app.models.pt_session import PTSession  # 순환 참조 발생
     from app.models.exercise_record import ExerciseRecord
     from sqlalchemy.orm import relationship
     
     class Member(Base):
         __tablename__ = "members"
         id = Column(String(36), primary_key=True)
         # ... 다른 필드들 ...
         
         # 직접 모델을 import하여 사용
         pt_sessions = relationship(PTSession, back_populates="member")
         exercise_records = relationship(ExerciseRecord, back_populates="member")

     # app/models/pt_session.py
     from app.models.member_model import Member  # 순환 참조 발생
     from app.models.exercise_record import ExerciseRecord
     from sqlalchemy.orm import relationship
     
     class PTSession(Base):
         __tablename__ = "pt_sessions"
         id = Column(String(36), primary_key=True)
         member_id = Column(String(36), ForeignKey('members.id'))
         # ... 다른 필드들 ...
         
         # 직접 모델을 import하여 사용
         member = relationship(Member, back_populates="pt_sessions")
         exercise_records = relationship(ExerciseRecord, back_populates="session")
     ```

   - 해결 과정:
     1. 순환 참조가 발생하는 모든 모델 관계 파악
     2. SQLAlchemy의 relationship 설정 방식 연구
     3. 다양한 해결 방법 시도 (지연 로딩, 문자열 참조 등)

   - 최종 해결된 코드:
     ```python
     # app/models/member_model.py
     from sqlalchemy.orm import relationship
     
     class Member(Base):
         __tablename__ = "members"
         id = Column(String(36), primary_key=True)
         # ... 다른 필드들 ...
         
         # 문자열로 모델 참조
         pt_sessions = relationship("PTSession", back_populates="member")
         exercise_records = relationship("ExerciseRecord", back_populates="member")

     # app/models/pt_session.py
     from sqlalchemy.orm import relationship
     
     class PTSession(Base):
         __tablename__ = "pt_sessions"
         id = Column(String(36), primary_key=True)
         member_id = Column(String(36), ForeignKey('members.id'))
         # ... 다른 필드들 ...
         
         # 문자열로 모델 참조
         member = relationship("Member", back_populates="pt_sessions")
         exercise_records = relationship("ExerciseRecord", back_populates="session")

     # app/models/__init__.py
     from .base import Base
     from .member_model import Member
     from .pt_session import PTSession
     from .exercise_record import ExerciseRecord

     # 모든 모델을 한 번에 import
     __all__ = ['Base', 'Member', 'PTSession', 'ExerciseRecord']
     ```

   - 최종 해결 방법:
     - relationship 정의 시 문자열로 모델 참조
     - `__init__.py`에서 모든 모델을 한 번에 import하여 순환 참조 방지
     - 각 모델 파일에서 다른 모델 직접 import 제거

   - 학습한 점:
     - SQLAlchemy의 relationship 동작 방식 이해
     - Python의 모듈 로딩 메커니즘에 대한 이해
     - 순환 참조를 피하는 설계 패턴
     - SQLAlchemy에서 문자열 참조를 사용하는 이유와 장점

2. **Git 보안 이슈**
   - 문제: GitHub 보안 검사에서 API 키 노출 감지
   - 원인 분석: 환경 변수 파일이 Git에 포함됨
   - 해결 과정: 
     1. Git 히스토리에서 API 키 완전 제거를 위한 다양한 시도
     2. `git filter-branch` 명령어 사용 시 발생하는 문제들 해결
     3. 원격 저장소 강제 푸시 후 발생하는 문제 대응
   - 최종 해결 방법: 
     - `git filter-branch` 명령어로 히스토리 정리
     - 환경 변수 관리 방식 개선
   - 학습한 점:
     - Git 히스토리 관리의 중요성
     - 환경 변수 관리 베스트 프랙티스
     - GitHub 보안 정책에 대한 이해

3. OpenAI API 연동 문제
   - 문제: API 키 로딩 실패
   - 원인: 환경 변수 로딩 시점 문제
   - 해결: 
     - dotenv 라이브러리 적용
     - LangChain으로 API 호출 방식 변경
     - 초기화 순서 조정

