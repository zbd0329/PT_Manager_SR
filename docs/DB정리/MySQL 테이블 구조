-- 트레이너 & 일반 사용자 정보
CREATE TABLE users (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),  
    login_id VARCHAR(50) UNIQUE NOT NULL,  
    email VARCHAR(100) UNIQUE,  
    name VARCHAR(50) NOT NULL,  
    birth_date DATE,  
    password VARCHAR(255) NOT NULL,  
    user_type ENUM('MEMBER', 'TRAINER') NOT NULL  
);

-- 회원 정보
CREATE TABLE members (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),  
    sequence_number INT NOT NULL UNIQUE,  -- 회원 순번 (트레이너별로 관리)
    login_id VARCHAR(50) UNIQUE NOT NULL,  
    password VARCHAR(255) NOT NULL,  
    name VARCHAR(255) NOT NULL,  
    gender ENUM('M', 'F') NOT NULL,  
    contact VARCHAR(20) NOT NULL,  
    total_pt_count INT DEFAULT 0,  -- 총 PT 등록 횟수
    remaining_pt_count INT DEFAULT 0,  -- 남은 PT 횟수
    notes TEXT NULL,  
    is_active BOOLEAN DEFAULT TRUE,  
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP  
);

-- 트레이너 & 회원 관계 테이블 (M:N)
CREATE TABLE users_members (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),  
    trainer_id CHAR(36) NOT NULL,  
    member_id CHAR(36) NOT NULL,  
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,  
    FOREIGN KEY (trainer_id) REFERENCES users(id) ON DELETE CASCADE,  
    FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE,
    UNIQUE KEY unique_trainer_member (trainer_id, member_id)  -- 중복 관계 방지
);

-- PT 수업 기록 테이블
CREATE TABLE pt_sessions (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    member_id CHAR(36) NOT NULL,
    trainer_id CHAR(36) NOT NULL,
    session_number INT NOT NULL,  -- PT 회차
    session_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    is_completed BOOLEAN DEFAULT FALSE,  -- 수업 완료 여부
    notes TEXT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE,
    FOREIGN KEY (trainer_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_session (member_id, trainer_id, session_number)  -- 회차 중복 방지
);

-- 운동 기록 테이블
CREATE TABLE exercise_records (
    id CHAR(36) PRIMARY KEY DEFAULT (UUID()),  
    session_id CHAR(36) NOT NULL,  -- PT 세션 ID 추가
    exercise_name VARCHAR(100) NOT NULL,       
    duration INT NOT NULL,                     
    repetitions INT NOT NULL,                  
    sets INT NOT NULL DEFAULT 1,               -- 세트 수 추가
    body_part TEXT NOT NULL,                   
    input_source ENUM('MEMBER', 'TRAINER') NOT NULL DEFAULT 'MEMBER',  
    member_id CHAR(36) NOT NULL,               
    trainer_id CHAR(36) NULL,                  
    notes TEXT NULL,                           
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,  
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,  
    FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE,  
    FOREIGN KEY (trainer_id) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (session_id) REFERENCES pt_sessions(id) ON DELETE CASCADE
);

-- 추천 운동 프로그램 테이블
CREATE TABLE recommended_workouts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    member_id CHAR(36) NOT NULL,
    session_id CHAR(36) NOT NULL,
    workout_name VARCHAR(100) NOT NULL,
    total_duration INT NOT NULL,  -- 분 단위
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (member_id) REFERENCES members(id) ON DELETE CASCADE,
    FOREIGN KEY (session_id) REFERENCES pt_sessions(id) ON DELETE CASCADE,
    INDEX idx_member_id (member_id),
    INDEX idx_session_id (session_id)
);

-- 추천 운동 상세 테이블
CREATE TABLE recommended_exercises (
    id INT AUTO_INCREMENT PRIMARY KEY,
    workout_id INT NOT NULL,
    exercise_name VARCHAR(100) NOT NULL,
    sets INT NOT NULL,
    repetitions INT NOT NULL,
    duration INT NOT NULL,  -- 초 단위
    rest_time INT NOT NULL,  -- 초 단위
    description TEXT,
    sequence INT NOT NULL,  -- 운동 순서
    FOREIGN KEY (workout_id) REFERENCES recommended_workouts(id) ON DELETE CASCADE,
    INDEX idx_workout_id (workout_id)
);

-- 인덱스 추가
CREATE INDEX idx_members_login ON members(login_id);
CREATE INDEX idx_users_login ON users(login_id);
CREATE INDEX idx_pt_sessions_date ON pt_sessions(session_date);
CREATE INDEX idx_exercise_records_session ON exercise_records(session_id);
